<%= form_with(model: [event, participant], 
              id: dom_id(participant), 
              class: "space-y-4 bg-gray-50 p-4 rounded-md shadow-sm mb-6",
              data: { controller: "properties" }) do |f| %>
  
  <% if participant.errors.any? %>
    <div class="text-red-500 text-sm">
      <%= participant.errors.full_messages.join(", ") %>
    </div>
  <% end %>

  <div>
    <%= f.label :name, "名前", class: "block text-sm font-medium text-gray-700" %>
    <%= f.text_field :name, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", placeholder: "参加者名", maxlength: 20 %>
  </div>

  <div class="space-y-4">
    <h3 class="text-sm font-medium text-gray-700">属性</h3>

    <%# 1. Configured Attributes %>
    <% if event.participant_attributes_config.present? %>
      <div class="bg-white p-3 rounded-md border border-gray-200 space-y-3">
        <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">設定済みの項目</h4>
        <% event.participant_attributes_config.each_with_index do |config, index| %>
          <% label = config['label'] %>
          <% required = config['required'].to_s == '1' || config['required'] == true %>
          <% current_value = participant.properties[label] if participant.properties %>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">
              <%= label %>
              <% if required %>
                <span class="text-red-500 text-xs ml-1">*必須</span>
              <% else %>
                <span class="text-gray-400 text-xs ml-1">(任意)</span>
              <% end %>
            </label>
            <input type="hidden" name="participant[properties_attributes][<%= index %>][key]" value="<%= label %>">
            <input type="text" name="participant[properties_attributes][<%= index %>][value]" value="<%= current_value %>" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="<%= label %>を入力">
          </div>
        <% end %>
      </div>
    <% end %>

    <%# 2. Free Input Attributes %>
    <div class="space-y-2">
      <label class="block text-sm font-medium text-gray-700">
        その他の属性
        <span class="text-gray-400 text-xs ml-1">(自由入力)</span>
      </label>
      
      <div data-properties-target="container">
        <%# Render existing properties that are NOT in config %>
        <% if participant.properties.present? %>
          <% config_labels = event.participant_attributes_config&.map { |c| c['label'] } || [] %>
          <% participant.properties.each do |key, value| %>
            <% next if config_labels.include?(key) %>
            <% index = Time.now.to_i + rand(1000) %>
            <div class="property-field flex space-x-2 mt-2">
              <input type="text" name="participant[properties_attributes][<%= index %>][key]" value="<%= key %>" placeholder="項目名 (例: 趣味)" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              <input type="text" name="participant[properties_attributes][<%= index %>][value]" value="<%= value %>" placeholder="値 (例: サッカー)" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              <button type="button" data-action="properties#remove" class="text-red-600 hover:text-red-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
          <% end %>
        <% end %>
      </div>

      <button type="button" 
              data-action="properties#add"
              class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        + 属性を追加
      </button>
    </div>
  </div>

  <div class="flex items-center space-x-3">
    <%= f.submit participant.persisted? ? "更新する" : "追加する", class: "flex-1 flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
    <% if participant.persisted? %>
      <%= link_to "キャンセル", event_path(event), class: "flex-1 flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
    <% end %>
  </div>

  <template data-properties-target="template">
    <div class="property-field flex space-x-2 mt-2">
      <input type="text" name="participant[properties_attributes][TEMPLATE_INDEX][key]" placeholder="項目名 (例: 趣味)" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
      <input type="text" name="participant[properties_attributes][TEMPLATE_INDEX][value]" placeholder="値 (例: サッカー)" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
      <button type="button" data-action="properties#remove" class="text-red-600 hover:text-red-800">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
  </template>
<% end %>
